<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Efektivitas Running - v3.7 Final SDT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; color: #1e293b; -webkit-tap-highlight-color: transparent; }
        .input-base { width: 100%; background: white; border: 1px solid #cbd5e1; border-radius: 6px; padding: 8px; font-weight: 600; outline: none; transition: 0.2s; }
        .input-base:focus { border-color: #4f46e5; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1); }
        .time-digit { width: 32px; text-align: center; border: none; outline: none; font-weight: 700; color: #334155; background: transparent; }
        .time-box { display: flex; align-items: center; justify-content: center; gap: 2px; background: white; border: 1px solid #e2e8f0; border-radius: 6px; padding: 4px; }
        .table-input { width: 100%; text-align: center; background: transparent; border: none; border-bottom: 2px solid #e2e8f0; font-weight: 700; padding: 4px; outline: none; }
        .table-input:focus { border-bottom-color: #4f46e5; background: #f8fafc; }
        .chip-label input:checked + div { background-color: #4f46e5; color: white; border-color: #4f46e5; }
        .chip-div { padding: 4px 10px; border-radius: 99px; border: 1px solid #cbd5e1; background: white; color: #64748b; font-size: 11px; font-weight: 700; transition: 0.2s; cursor: pointer; }
        .tab-btn { padding: 6px 16px; border-radius: 6px; font-size: 12px; font-weight: 700; color: #64748b; transition: 0.2s; }
        .tab-btn.active { background: white; color: #1e293b; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .page { display: none; padding-bottom: 120px; animation: fadeEffect 0.3s; }
        .page.active { display: block; }
        @keyframes fadeEffect { from {opacity: 0; transform: translateY(10px);} to {opacity: 1; transform: translateY(0);} }
        .fab { position: fixed; bottom: 24px; right: 24px; width: 56px; height: 56px; background-color: #4f46e5; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4); z-index: 50; transition: transform 0.2s; }
        .fab:active { transform: scale(0.95); }
        #sync-overlay { position: fixed; top:0; left:0; width:100%; height:4px; z-index: 999; background: transparent; pointer-events: none;}
        .progress-bar { height: 100%; background: #4f46e5; width: 0%; transition: width 0.3s; }
        .spinner { border: 2px solid #f3f3f3; border-top: 2px solid #4f46e5; border-radius: 50%; width: 14px; height: 14px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-100">

    <div id="sync-overlay"><div class="progress-bar" id="progressBar"></div></div>

    <!-- Navbar Global -->
    <div class="bg-slate-900 text-white py-4 px-4 sticky top-0 z-50 shadow-md flex justify-between items-center h-16">
        <div class="flex items-center gap-3">
            <button id="btnBack" onclick="nav('history')" class="hidden text-slate-300 hover:text-white"><i data-lucide="arrow-left"></i></button>
            <div>
                <h1 class="text-lg font-bold" id="navTitle">Riwayat Laporan</h1>
                <p class="text-slate-400 text-[10px]" id="navSubtitle">List Tersimpan</p>
            </div>
        </div>
        <div class="flex gap-2">
            <button id="btnAdmin" onclick="nav('admin')" class="p-2 text-slate-400 hover:text-white rounded-full"><i data-lucide="settings"></i></button>
            <button id="btnSave" onclick="saveData(false)" class="hidden bg-emerald-600 hover:bg-emerald-700 text-xs font-bold py-2 px-3 rounded flex items-center gap-1"><i data-lucide="save" class="w-4 h-4"></i> SIMPAN</button>
        </div>
    </div>

    <!-- CONFIG FOR GOOGLE SHEETS -->
    <script>const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx2SsLCoMnBGOZq696cZWXvg7j7_hmpBbWxd-H8nrDSl_VpvxXwhtSNuU16L_fPkOGj/exec";</script>

    <div class="max-w-3xl mx-auto mt-6 px-4">

        <!-- ================= PAGE 1: HISTORY ================= -->
        <div id="page-history" class="page active">
            <div id="history-container" class="space-y-3"></div>
            <div id="loading" class="hidden text-center text-slate-400 text-xs py-4 flex justify-center items-center gap-2"><div class="spinner"></div> Mengambil data Cloud...</div>
            <div id="empty-history" class="hidden text-center py-10 text-slate-400 text-sm">Belum ada history laporan.<br><span class="text-[10px]">(Cek koneksi internet untuk load dari Cloud)</span></div>
            <button onclick="openCreate()" class="fab"><i data-lucide="plus" class="w-8 h-8"></i></button>
        </div>

        <!-- ================= PAGE 2: ADMIN ================= -->
        <div id="page-admin" class="page">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-bold text-slate-700">Data Master</h2>
                <button onclick="forceSync()" class="bg-white border border-indigo-200 text-indigo-700 hover:bg-indigo-50 text-xs font-bold py-2 px-4 rounded shadow-sm flex items-center gap-2"><i data-lucide="refresh-cw" class="w-3 h-3"></i> Refresh Data Cloud</button>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden relative">
                <div id="admin-loading" class="absolute inset-0 bg-white/80 z-10 flex items-center justify-center hidden"><div class="spinner border-slate-300 border-t-indigo-600 w-6 h-6"></div></div>
                <div class="p-4 space-y-6" id="admin-content"></div>
                <div class="px-4 pb-4 text-xs text-slate-400 text-center border-t border-slate-100 pt-4">Setiap perubahan (Tambah/Hapus) akan otomatis disimpan ke Cloud.</div>
            </div>
        </div>

        <!-- ================= PAGE 3: FORM ================= -->
        <div id="page-form" class="page">
            <input type="hidden" id="editId">

            <!-- 0. DATA OPERASI -->
            <section class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-6">
                <div class="bg-slate-50 px-4 py-3 border-b border-slate-100 font-bold text-slate-700 text-sm">0. Data Operasional</div>
                <div class="p-4 space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Shift</label><select id="inputShift" class="input-base"><option value="NIGHT SHIFT">üåô NIGHT SHIFT</option><option value="DAY SHIFT">‚òÄÔ∏è DAY SHIFT</option></select></div>
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Tanggal</label><input type="date" id="inputTanggal" class="input-base"></div>
                    </div>
                    <div><label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Supervisor</label><div id="spvContainer" class="flex flex-wrap gap-2 mb-2"></div><input id="inputSupervisorLainnya" placeholder="+ Manual" class="text-sm w-full border-b py-1 outline-none focus:border-indigo-500"></div>
                    <div><label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Foreman</label><div id="foremanContainer" class="flex flex-wrap gap-2 mb-2"></div><input id="inputForemanLainnya" placeholder="+ Manual" class="text-sm w-full border-b py-1 outline-none focus:border-indigo-500"></div>
                    <div><label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Checker</label><div id="checkerContainer" class="flex flex-wrap gap-2 mb-2"></div><input id="inputCheckerLainnya" placeholder="+ Manual" class="text-sm w-full border-b py-1 outline-none focus:border-indigo-500"></div>
                    <div class="grid grid-cols-1 gap-4 pt-2">
                        <div class="bg-blue-50 p-3 rounded border border-blue-100"><label class="text-[10px] font-bold text-blue-600 block">TIPPING ROM</label><input type="number" id="inputTippingRom" placeholder="0" class="w-full bg-transparent text-xl font-black text-blue-900 outline-none"></div>
                    </div>
                </div>
            </section>

            <!-- 1. DURASI CONVEYOR -->
            <section class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-6">
                <div class="bg-slate-50 px-4 py-3 border-b border-slate-100 flex justify-between items-center">
                    <div><h2 class="font-bold text-slate-700 text-sm">1. Durasi Conveyor</h2><p class="text-[10px] text-slate-400">Input Jam Indikasi</p></div>
                    <div class="flex bg-slate-200 p-1 rounded-md"><button onclick="switchTab('SD1')" id="tab-SD1" class="tab-btn active">SD1</button><button onclick="switchTab('SD2')" id="tab-SD2" class="tab-btn">SD2</button><button onclick="switchTab('SD3')" id="tab-SD3" class="tab-btn">SD3</button></div>
                </div>
                <div class="p-4">
                    <div class="grid grid-cols-12 gap-2 text-[10px] font-bold text-slate-400 text-center mb-2"><div class="col-span-1">#</div><div class="col-span-5">Mulai</div><div class="col-span-5">Selesai</div><div class="col-span-1">Del</div></div>
                    <div id="container-SD1" class="space-y-2"></div><div id="container-SD2" class="space-y-2 hidden"></div><div id="container-SD3" class="space-y-2 hidden"></div>
                    <button onclick="addTimeRow(activeSD)" class="mt-4 w-full py-3 border border-dashed border-slate-300 text-slate-500 font-bold text-xs rounded hover:bg-slate-50">+ Tambah Baris</button>
                    <div id="results" class="mt-6 grid grid-cols-3 gap-2 border-t border-slate-100 pt-4">
                        <div class="bg-slate-50 p-2 rounded text-center border border-slate-200">
                            <div class="text-[10px] text-slate-400 font-bold">SD1 Running</div>
                            <div id="eff-SD1" class="text-sm font-black text-emerald-600" data-copy="-">-</div>
                            <div id="res-SD1" class="text-[9px] font-bold text-slate-400 mt-1">Indikasi: -</div>
                        </div>
                        <div class="bg-slate-50 p-2 rounded text-center border border-slate-200">
                            <div class="text-[10px] text-slate-400 font-bold">SD2 Running</div>
                            <div id="eff-SD2" class="text-sm font-black text-emerald-600" data-copy="-">-</div>
                            <div id="res-SD2" class="text-[9px] font-bold text-slate-400 mt-1">Indikasi: -</div>
                        </div>
                        <div class="bg-slate-50 p-2 rounded text-center border border-slate-200">
                            <div class="text-[10px] text-slate-400 font-bold">SD3 Running</div>
                            <div id="eff-SD3" class="text-sm font-black text-emerald-600" data-copy="-">-</div>
                            <div id="res-SD3" class="text-[9px] font-bold text-slate-400 mt-1">Indikasi: -</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 2. UNIT RUNNING (DYNAMIC PT) -->
            <section class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-6">
                <div class="bg-slate-50 px-4 py-3 border-b border-slate-100 font-bold text-slate-700 text-sm">2. Perhitungan Unit Running</div>
                <div class="p-4 space-y-6">
                    <div class="grid grid-cols-12 bg-slate-50 font-bold text-[10px] text-slate-400 py-2 border-b border-slate-200 text-center">
                        <div class="col-span-2">SHIFT</div><div class="col-span-4">UNIT RUNNING</div><div class="col-span-4">TRIP</div><div class="col-span-2">2 TRIP</div>
                    </div>
                    <div id="haulingRowsContainer"></div>
                    <div class="bg-slate-100 p-3 rounded flex justify-between items-center text-sm"><span class="font-bold text-slate-500">Total Hauling</span><span id="grand-total" class="font-black text-indigo-700 text-lg">0 Trip</span></div>
                </div>
            </section>

            <!-- 3. UNIT SDT RUNNING (MULTI DRIVER FIXED) -->
            <section class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-6">
                <div class="bg-slate-50 px-4 py-3 border-b border-slate-100 flex justify-between items-center">
                    <h2 class="font-bold text-slate-700 text-sm">3. Unit SDT Running</h2>
                </div>
                <div class="p-4">
                    <div class="mb-4"><div id="unitBtnContainer" class="flex flex-wrap gap-2"></div></div>
                    <div id="sdtList" class="space-y-3"></div>
                    <div id="emptyMsg" class="text-center py-6 text-slate-300 text-xs italic border border-dashed rounded mt-2">Belum ada data. Klik tombol unit di atas.</div>
                    
                    <div class="bg-slate-100 p-3 rounded flex justify-between items-center text-sm mt-4 border border-slate-200">
                        <span class="font-bold text-slate-500">Total Trip SDT</span>
                        <span id="totalSdtDisplay" class="font-black text-indigo-700 text-lg">0 Trip</span>
                    </div>
                </div>
            </section>

            <div class="grid grid-cols-2 gap-3 pb-8">
                <button onclick="copyReport(false)" class="bg-white border border-purple-200 text-purple-700 font-bold py-3 rounded-xl shadow-sm hover:bg-purple-50 text-xs flex justify-center items-center gap-2"><i data-lucide="sun" class="w-4 h-4"></i> Salin SIANG</button>
                <button onclick="copyReport(true)" class="bg-white border border-indigo-200 text-indigo-700 font-bold py-3 rounded-xl shadow-sm hover:bg-indigo-50 text-xs flex justify-center items-center gap-2"><i data-lucide="moon" class="w-4 h-4"></i> Salin MALAM</button>
            </div>
        </div>

    </div>

    <!-- MODAL -->
    <div id="customModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-[60]">
        <div class="bg-white p-6 rounded-xl shadow-xl w-11/12 max-w-sm transform transition-all scale-100">
            <h3 id="modalTitle" class="font-bold text-lg mb-2 text-slate-800">Judul</h3>
            <p id="modalMsg" class="text-sm text-slate-600 mb-4 hidden">Pesan konfirmasi...</p>
            <input id="modalInput" type="text" class="input-base mb-4 hidden" placeholder="Ketik disini...">
            <div id="driverChecklist" class="hidden max-h-48 overflow-y-auto border border-slate-200 rounded p-2 mb-4 space-y-2"></div>
            <div class="flex justify-end gap-2">
                <button onclick="closeModal()" class="px-4 py-2 text-slate-500 font-bold text-xs hover:bg-slate-100 rounded">BATAL</button>
                <button id="modalActionBtn" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold text-xs">OK</button>
            </div>
        </div>
    </div>
    <div id="toast" class="fixed bottom-5 right-5 bg-slate-800 text-white px-4 py-3 rounded shadow-xl text-xs hidden transition-all duration-300 transform translate-y-10 z-50">Teks berhasil disalin!</div>

    <script>
        let appData = { history: [], masters: { spv: [], foreman: [], checker: [], pt: [], unit: [], driver: [] } };
        let activeSD = 'SD1';
        let conveyorData = { SD1:[], SD2:[], SD3:[] };
        let sdtData = [];
        let modalCallback = null;

        const toId = (str) => str.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
        const getColor = (str) => {
            const colors = ['bg-orange-500', 'bg-emerald-500', 'bg-yellow-500', 'bg-blue-500', 'bg-purple-500', 'bg-pink-500'];
            let hash = 0; for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            return colors[Math.abs(hash) % colors.length];
        };

        window.onload = () => {
            loadFromStorage();
            if (GOOGLE_SCRIPT_URL) { syncDown(); }
            lucide.createIcons();
            initChips();
            renderUnitButtons();
            renderHaulingInputs();
            renderHistory();
            renderAdmin();
            document.getElementById('inputTanggal').valueAsDate = new Date();
        };

        function nav(pageId) {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
            const btnBack = document.getElementById('btnBack'), btnAdmin = document.getElementById('btnAdmin'), btnSave = document.getElementById('btnSave'), navTitle = document.getElementById('navTitle'), navSubtitle = document.getElementById('navSubtitle');
            if(pageId === 'history') { btnBack.classList.add('hidden'); btnAdmin.classList.remove('hidden'); btnSave.classList.add('hidden'); navTitle.innerText = "Riwayat Laporan"; navSubtitle.innerText = "List Tersimpan"; renderHistory(); } 
            else if (pageId === 'form') { btnBack.classList.remove('hidden'); btnAdmin.classList.add('hidden'); btnSave.classList.remove('hidden'); navTitle.innerText = document.getElementById('editId').value ? "Edit Laporan" : "Laporan Baru"; navSubtitle.innerText = "Form Input"; renderHaulingInputs(); renderUnitButtons(); } 
            else if (pageId === 'admin') { btnBack.classList.remove('hidden'); btnAdmin.classList.add('hidden'); btnSave.classList.add('hidden'); navTitle.innerText = "Pengaturan"; navSubtitle.innerText = "Kelola Master Data"; renderAdmin(); }
            window.scrollTo(0,0);
        }

        // --- HAULING INPUTS ---
        function renderHaulingInputs() {
            const container = document.getElementById('haulingRowsContainer');
            if(!container) return;
            const oldValues = {};
            appData.masters.pt.forEach(pt => {
                const k = toId(pt);
                ['run-siang','trip-siang','run-malam','trip-malam'].forEach(s => {
                    const el = document.getElementById(`${k}-${s}`);
                    if(el) oldValues[`${k}-${s}`] = el.value;
                });
            });
            container.innerHTML = '';
            if(!appData.masters.pt) appData.masters.pt = ['MHA', 'KARUNIA', 'BUMA'];
            appData.masters.pt.forEach(ptName => {
                const id = toId(ptName);
                const colorClass = getColor(ptName);
                const html = `
                <div class="mb-4 ptInputGroup" data-pt="${ptName}">
                    <div class="flex items-center gap-2 mb-1"><div class="w-2 h-2 rounded-full ${colorClass}"></div><span class="text-xs font-bold text-slate-700">${ptName}</span></div>
                    <div class="border border-slate-200 rounded-lg overflow-hidden text-center text-xs">
                        <div class="grid grid-cols-12 py-1 items-center border-b border-slate-100">
                            <div class="col-span-2">‚òÄÔ∏è</div>
                            <div class="col-span-4 px-1"><input type="number" id="${id}-run-siang" class="table-input" placeholder="0" oninput="calcUnit('${id}')"></div>
                            <div class="col-span-4 px-1"><input type="number" id="${id}-trip-siang" class="table-input" placeholder="0" oninput="calcUnit('${id}')"></div>
                            <div class="col-span-2 font-black" id="${id}-res-siang">0</div>
                        </div>
                        <div class="grid grid-cols-12 py-1 items-center bg-slate-50/50">
                            <div class="col-span-2">üåô</div>
                            <div class="col-span-4 px-1"><input type="number" id="${id}-run-malam" class="table-input" placeholder="0" oninput="calcUnit('${id}')"></div>
                            <div class="col-span-4 px-1"><input type="number" id="${id}-trip-malam" class="table-input" placeholder="0" oninput="calcUnit('${id}')"></div>
                            <div class="col-span-2 font-black" id="${id}-res-malam">0</div>
                        </div>
                    </div>
                </div>`;
                container.innerHTML += html;
            });
            Object.keys(oldValues).forEach(key => { const el = document.getElementById(key); if(el) el.value = oldValues[key]; });
            calcTotalHauling(); 
        }

        // --- STORAGE & SYNC ---
        function loadFromStorage() {
            const h = localStorage.getItem('chp_history'), m = localStorage.getItem('chp_masters');
            if(h) appData.history = JSON.parse(h);
            if(m) appData.masters = JSON.parse(m);
            if(!appData.masters.pt || appData.masters.pt.length===0) appData.masters.pt = ['MHA', 'KARUNIA', 'BUMA'];
            if(!appData.masters.unit) appData.masters.unit = ["01-F", "02-F", "03-F", "3A-F", "05-F"];
            if(!appData.masters.driver) appData.masters.driver = ["Jeksen", "Saipul"];
        }
        function saveToStorage() {
            localStorage.setItem('chp_history', JSON.stringify(appData.history));
            localStorage.setItem('chp_masters', JSON.stringify(appData.masters));
            if(GOOGLE_SCRIPT_URL) {
                document.getElementById('progressBar').style.width = '30%';
                fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ history: appData.history, masters: appData.masters }) })
                .then(() => { document.getElementById('progressBar').style.width = '100%'; setTimeout(() => document.getElementById('progressBar').style.width = '0%', 500); showToast("Tersimpan ke Cloud!"); })
                .catch(e => showToast("Tersimpan Lokal (Offline)"));
            } else { showToast("Tersimpan Lokal!"); }
        }
        async function syncDown() {
            const loading = document.getElementById('loading'); loading.classList.remove('hidden'); document.getElementById('progressBar').style.width = '50%';
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL); const data = await response.json();
                if (data.history && Array.isArray(data.history)) appData.history = data.history.map(normalizeSdt);
                if (data.masters && typeof data.masters === 'object') appData.masters = data.masters;
                localStorage.setItem('chp_history', JSON.stringify(appData.history));
                localStorage.setItem('chp_masters', JSON.stringify(appData.masters));
                renderHistory(); renderAdmin(); initChips(); renderHaulingInputs(); renderUnitButtons();
                document.getElementById('progressBar').style.width = '100%'; showToast("Data Dipulihkan!");
            } catch (err) { console.error("Gagal Sync:", err); } 
            finally { loading.classList.add('hidden'); setTimeout(() => document.getElementById('progressBar').style.width = '0%', 500); }
        }
        function forceSync() { syncDown(); }
        // Migration to new structure
        function normalizeSdt(item) {
            if(item.sdt && item.sdt.length > 0 && !item.sdt[0].drivers) {
                item.sdt = item.sdt.map(d => ({
                    unit: d.unit, drivers: [{name: d.driver||'', jam: '', trip: d.trip||'', ket: d.ket||''}], ket: ''
                }));
            }
            return item;
        }

        // --- MODAL ---
        function showModal(title, type, callback, msgText = '') {
            const modal = document.getElementById('customModal'); document.getElementById('modalTitle').innerText = title;
            const mInput = document.getElementById('modalInput'), mMsg = document.getElementById('modalMsg'), mCheck = document.getElementById('driverChecklist');
            mInput.classList.add('hidden'); mMsg.classList.add('hidden'); mCheck.classList.add('hidden');
            if (type === 'input') { mInput.classList.remove('hidden'); mInput.value = ''; setTimeout(() => mInput.focus(), 100); } 
            else if (type === 'confirm') { mMsg.classList.remove('hidden'); mMsg.innerText = msgText; } 
            else if (type === 'checklist') { mCheck.classList.remove('hidden'); mCheck.innerHTML = appData.masters.driver.map(d => `<label class="flex items-center gap-2 p-2 border-b last:border-0 hover:bg-slate-50"><input type="checkbox" value="${d}" class="w-4 h-4 text-indigo-600 rounded"><span class="text-xs font-bold text-slate-700">${d}</span></label>`).join(''); }
            modal.classList.remove('hidden');
            document.getElementById('modalActionBtn').onclick = () => {
                if (type === 'input') { if(mInput.value.trim()) callback(mInput.value.trim()); }
                else if (type === 'checklist') { const checked = Array.from(mCheck.querySelectorAll('input:checked')).map(c => c.value); callback(checked); } 
                else { callback(); } closeModal();
            };
        }
        function closeModal() { document.getElementById('customModal').classList.add('hidden'); modalCallback = null; }

        // --- HISTORY ---
        function renderHistory() {
            const c = document.getElementById('history-container'); c.innerHTML = '';
            if(appData.history.length === 0) { document.getElementById('empty-history').classList.remove('hidden'); } 
            else {
                document.getElementById('empty-history').classList.add('hidden');
                [...appData.history].reverse().forEach(item => {
                    const el = document.createElement('div');
                    el.className = "bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex justify-between items-start";
                    const d = new Date(item.tanggal);
                    const dateStr = `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;
                    el.innerHTML = `<div class="flex-1 cursor-pointer" onclick="loadReport('${item.id}')"><div class="flex items-center gap-2 mb-1"><span class="text-[10px] font-bold px-2 py-0.5 rounded ${item.shift.includes('NIGHT') ? 'bg-indigo-100 text-indigo-700' : 'bg-orange-100 text-orange-700'}">${item.shift}</span><span class="text-xs font-bold text-slate-500">${dateStr}</span></div><h3 class="font-bold text-slate-800 text-sm">Total Hauling: ${item.totalHauling}</h3><div class="text-[10px] text-slate-400 mt-1 truncate max-w-[200px]">SPV: ${item.spv}</div></div><div class="flex flex-col gap-2 ml-2"><button onclick="loadReport('${item.id}')" class="p-2 bg-slate-50 hover:bg-slate-100 rounded border border-slate-200 text-slate-500"><i data-lucide="edit-2" class="w-4 h-4"></i></button><button onclick="reqDeleteReport('${item.id}')" class="p-2 bg-red-50 hover:bg-red-100 rounded border border-red-100 text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`;
                    c.appendChild(el);
                });
                lucide.createIcons();
            }
        }
        function openCreate() { resetForm(); nav('form'); }
        function reqDeleteReport(id) { showModal('Hapus Laporan?', 'confirm', () => { appData.history = appData.history.filter(x => x.id !== id); saveToStorage(); renderHistory(); }, 'Yakin hapus history ini?'); }

        // --- FORM LOGIC ---
        function resetForm() {
            document.getElementById('editId').value = '';
            document.getElementById('inputShift').value = 'NIGHT SHIFT';
            document.getElementById('inputTanggal').valueAsDate = new Date();
            document.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked = false);
            document.getElementById('inputSupervisorLainnya').value = '';
            document.getElementById('inputForemanLainnya').value = '';
            document.getElementById('inputCheckerLainnya').value = '';
            renderHaulingInputs(); 
            appData.masters.pt.forEach(pt => {
                const k = toId(pt);
                const el = document.getElementById(`${k}-run-siang`);
                if(el) { ['run-siang','trip-siang','run-malam','trip-malam'].forEach(s => document.getElementById(`${k}-${s}`).value = ''); document.getElementById(`${k}-res-siang`).innerText = '0'; document.getElementById(`${k}-res-malam`).innerText = '0'; }
            });
            document.getElementById('grand-total').innerText = '0 Trip';
            document.getElementById('inputTippingRom').value = '';
            document.getElementById('totalSdtDisplay').innerText = '0 Trip';
            conveyorData = { SD1:[], SD2:[], SD3:[] };
            ['SD1','SD2','SD3'].forEach(sd => { document.getElementById(`container-${sd}`).innerHTML = ''; addTimeRow(sd); });
            sdtData = []; renderSdtList();
        }

        function saveData(silent = false) {
            const id = document.getElementById('editId').value || Date.now().toString();
            const data = {
                id: id, timestamp: Date.now(), shift: document.getElementById('inputShift').value, tanggal: document.getElementById('inputTanggal').value,
                spv: getChecked('spvContainer'), foreman: getChecked('foremanContainer'), checker: getChecked('checkerContainer'),
                tipping: document.getElementById('inputTippingRom').value,
                transfer: document.getElementById('totalSdtDisplay').innerText.replace(' Trip',''),
                conveyor: conveyorData,
                conveyorRes: { SD1: document.getElementById('eff-SD1').dataset.copy, SD2: document.getElementById('eff-SD2').dataset.copy, SD3: document.getElementById('eff-SD3').dataset.copy },
                inputs: {}, totalHauling: document.getElementById('grand-total').innerText, sdt: sdtData
            };
            appData.masters.pt.forEach(pt => { const k = toId(pt); if(document.getElementById(`${k}-run-siang`)) { data.inputs[k] = {}; ['run-siang','trip-siang','run-malam','trip-malam'].forEach(s => { data.inputs[k][s] = document.getElementById(`${k}-${s}`).value; }); } });
            const existingIdx = appData.history.findIndex(x => x.id === id);
            if(existingIdx > -1) { appData.history[existingIdx] = data; } else { appData.history.push(data); }
            saveToStorage(); 
            if(!silent) { setTimeout(() => nav('history'), 500); }
        }

        function loadReport(id) {
            const data = appData.history.find(x => x.id === id);
            if(!data) return;
            const cleanData = normalizeSdt(JSON.parse(JSON.stringify(data))); 
            resetForm(); 
            document.getElementById('editId').value = cleanData.id;
            document.getElementById('inputShift').value = cleanData.shift;
            document.getElementById('inputTanggal').value = cleanData.tanggal;
            const loadChecks = (cntId, str) => { const arr = str.split(', '); document.querySelectorAll(`#${cntId} input`).forEach(cb => { if(arr.includes(cb.value)) cb.checked = true; }); };
            loadChecks('spvContainer', cleanData.spv); loadChecks('foremanContainer', cleanData.foreman); loadChecks('checkerContainer', cleanData.checker);
            document.getElementById('inputTippingRom').value = cleanData.tipping; 
            ['SD1','SD2','SD3'].forEach(sd => {
                document.getElementById(`container-${sd}`).innerHTML = '';
                conveyorData[sd] = cleanData.conveyor[sd];
                conveyorData[sd].forEach((row, idx) => renderTimeRow(sd, idx, row));
                if(conveyorData[sd].length === 0) addTimeRow(sd);
                calcConv(sd);
            });
            if(cleanData.inputs) {
                appData.masters.pt.forEach(pt => {
                    const k = toId(pt);
                    if(cleanData.inputs[k] && document.getElementById(`${k}-run-siang`)) {
                        ['run-siang','trip-siang','run-malam','trip-malam'].forEach(s => { document.getElementById(`${k}-${s}`).value = cleanData.inputs[k][s] || ''; });
                        calcUnit(k);
                    }
                });
            }
            sdtData = cleanData.sdt || []; renderSdtList();
            nav('form');
        }

        // --- CALCULATION DYNAMIC ---
        function calcUnit(id) {
            const val = (s) => parseFloat(document.getElementById(s).value)||0;
            const rs=val(`${id}-run-siang`), ts=val(`${id}-trip-siang`), rm=val(`${id}-run-malam`), tm=val(`${id}-trip-malam`);
            const resSiang = ts - rs;
            const resMalam = (tm > 0 ? (tm - ts) : 0) - rm;
            document.getElementById(`${id}-res-siang`).innerText = resSiang;
            document.getElementById(`${id}-res-malam`).innerText = resMalam;
            calcTotalHauling();
        }

        function calcTotalHauling() {
            let tot = 0;
            appData.masters.pt.forEach(pt => {
                const k = toId(pt);
                const val = (s) => parseFloat(document.getElementById(s)?.value)||0;
                const ts=val(`${k}-trip-siang`), tm=val(`${k}-trip-malam`);
                if (tm > 0) { tot += tm; } else { tot += ts; }
            });
            document.getElementById('grand-total').innerText = tot + " Trip";
        }

        function calcSdtTotal() {
            let tot = 0;
            sdtData.forEach(d => {
                d.drivers.forEach(sub => tot += (parseFloat(sub.trip)||0));
            });
            document.getElementById('totalSdtDisplay').innerText = tot + " Trip";
            return tot;
        }

        // --- CHIPS & TIME ---
        function initChips() { const mk = (id, list) => document.getElementById(id).innerHTML = list ? list.map(n => `<label class="chip-label inline-block mr-2 mb-1"><input type="checkbox" value="${n}" class="hidden"><div class="chip-div">${n}</div></label>`).join('') : ''; mk('spvContainer', appData.masters.spv); mk('foremanContainer', appData.masters.foreman); mk('checkerContainer', appData.masters.checker); }
        function switchTab(sd) { activeSD = sd; ['SD1','SD2','SD3'].forEach(n => { document.getElementById(`tab-${n}`).className = `tab-btn ${n===sd?'active':''}`; document.getElementById(`container-${n}`).className = `space-y-2 ${n===sd?'':'hidden'}`; }); }
        function addTimeRow(sd) { const idx = conveyorData[sd].length; const emptyRow = { sh:'', sm:'', fh:'', fm:'' }; conveyorData[sd].push(emptyRow); renderTimeRow(sd, idx, emptyRow); }
        function renderTimeRow(sd, idx, data) {
            const div = document.createElement('div'); div.id = `row-${sd}-${idx}`;
            div.className = "grid grid-cols-12 gap-2 items-center bg-white p-2 rounded border border-slate-100 shadow-sm";
            div.innerHTML = `<div class="col-span-1 text-center font-bold text-slate-300 text-xs">${idx+1}</div><div class="col-span-5 time-box"><input type="tel" value="${data.sh}" maxlength="2" placeholder="HH" class="time-digit" oninput="updTime('${sd}',${idx},'sh',this)">:<input type="tel" value="${data.sm}" maxlength="2" placeholder="MM" class="time-digit" oninput="updTime('${sd}',${idx},'sm',this)"></div><div class="col-span-5 time-box"><input type="tel" value="${data.fh}" maxlength="2" placeholder="HH" class="time-digit" oninput="updTime('${sd}',${idx},'fh',this)">:<input type="tel" value="${data.fm}" maxlength="2" placeholder="MM" class="time-digit" oninput="updTime('${sd}',${idx},'fm',this)"></div><div class="col-span-1 text-center"><button onclick="delTimeRow('${sd}',${idx})" class="text-slate-300 hover:text-red-500 font-bold">√ó</button></div>`;
            document.getElementById(`container-${sd}`).appendChild(div);
        }
        function updTime(sd, idx, f, el) { let v = el.value.replace(/\D/g,''); if(v.length>2) v=v.slice(0,2); if(v>23 && (f=='sh'||f=='fh')) v='23'; if(v>59 && (f=='sm'||f=='fm')) v='59'; el.value=v; conveyorData[sd][idx][f]=v; calcConv(sd); }
        function delTimeRow(sd, idx) { document.getElementById(`row-${sd}-${idx}`).style.display='none'; conveyorData[sd][idx] = { sh:'', sm:'', fh:'', fm:'' }; calcConv(sd); }
        function calcConv(sd) {
            let tot=0; conveyorData[sd].forEach(d => { if(d.sh!==''&&d.sm!==''&&d.fh!==''&&d.fm!=='') { let s = parseInt(d.sh)*60+parseInt(d.sm), f = parseInt(d.fh)*60+parseInt(d.fm); if(f<s) f+=1440; tot += (f-s); } });
            let runningMins = (12 * 60) - tot; if (runningMins < 0) runningMins = 0; 
            const rh=Math.floor(runningMins/60), rm=runningMins%60, ih=Math.floor(tot/60), im=tot%60;
            const elEff = document.getElementById(`eff-${sd}`), elRes = document.getElementById(`res-${sd}`);
            if(tot === 0) { elEff.innerText = "-"; elEff.dataset.copy = "-"; elRes.innerText = "Indikasi: -"; } 
            else { elEff.innerText = `${rh}j ${rm}m`; elEff.dataset.copy = `${rh} Jam ${rm} Menit`; elRes.innerText = `Indikasi: ${ih}j ${im}m`; }
        }

        // --- SDT MULTI DRIVER ---
        function addMasterFromForm(type) { showModal(`Tambah ${type}`, 'input', (val) => { appData.masters[type].push(val.toUpperCase()); saveToStorage(); if(type==='unit') renderUnitButtons(); else renderSdtList(); }); }
        function renderUnitButtons() { document.getElementById('unitBtnContainer').innerHTML = appData.masters.unit.map(u => `<button onclick="addSdt('${u}')" class="bg-white border border-slate-300 text-xs font-bold text-slate-600 px-3 py-1 rounded shadow-sm hover:bg-indigo-50 hover:text-indigo-600 transition active:scale-95">${u}</button>`).join(''); }
        function addSdt(u) { 
            // Default 1 empty driver row
            sdtData.push({ unit:u, drivers:[{name:'', jam:'', trip:'', ket:''}], ket:'' }); 
            renderSdtList(); setTimeout(() => document.getElementById('sdtList').lastElementChild?.scrollIntoView({behavior:'smooth', block:'center'}), 100); 
        }
        function delSdt(i) { sdtData.splice(i,1); renderSdtList(); calcSdtTotal(); }
        
        function selectDriver(i) {
            showModal("Pilih Driver", "checklist", (selected) => {
                const currentDrivers = sdtData[i].drivers || [];
                // Rebuild driver list: keep existing data if name matches, else add new
                const newDrivers = selected.map(name => {
                    const existing = currentDrivers.find(d => d.name === name);
                    return existing ? existing : { name: name, jam: '', trip: '', ket: '' };
                });
                if (newDrivers.length === 0) newDrivers.push({ name: '', jam: '', trip: '', ket: '' });
                sdtData[i].drivers = newDrivers;
                renderSdtList();
            });
        }

        // Handle inputs for specific driver sub-row
        function updSdtSub(i, subIdx, field, val) {
            sdtData[i].drivers[subIdx][field] = val;
            if(field === 'trip') calcSdtTotal();
        }

        function renderSdtList() {
            const c = document.getElementById('sdtList'); const m = document.getElementById('emptyMsg'); if(sdtData.length === 0) { c.innerHTML = ''; m.style.display = 'block'; calcSdtTotal(); return; } m.style.display = 'none';
            c.innerHTML = sdtData.map((d,i) => {
                const isMulti = d.drivers.length > 1;
                return `
                <div class="bg-white p-2 rounded-lg border border-slate-200 shadow-sm flex flex-col gap-2 relative">
                    <div class="flex justify-between items-center border-b border-slate-50 pb-1">
                        <span class="font-bold text-xs bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded">${d.unit}</span>
                        <div class="flex gap-2">
                            <button onclick="selectDriver(${i})" class="text-[10px] bg-slate-100 px-2 py-0.5 rounded font-bold hover:bg-slate-200">+ Driver</button>
                            <button onclick="delSdt(${i})" class="text-red-400 hover:text-red-600 transition p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <div class="space-y-2">
                        ${d.drivers.map((sub, subIdx) => `
                        <div class="grid grid-cols-12 gap-1 text-xs items-center">
                            <!-- Driver Name -->
                            <div class="${isMulti ? 'col-span-3' : 'col-span-4'}"><input type="text" value="${sub.name}" placeholder="Driver" oninput="updSdtSub(${i},${subIdx},'name',this.value)" class="w-full border rounded p-1 bg-white outline-none font-bold"></div>
                            
                            <!-- Jam (Only if Multi) -->
                            ${isMulti ? `<div class="col-span-2"><input type="text" value="${sub.jam}" placeholder="Jam" oninput="updSdtSub(${i},${subIdx},'jam',this.value)" class="w-full border rounded p-1 bg-white outline-none text-center"></div>` : ''}
                            
                            <!-- Trip -->
                            <div class="${isMulti ? 'col-span-2' : 'col-span-3'} relative"><input type="number" value="${sub.trip}" placeholder="0" oninput="updSdtSub(${i},${subIdx},'trip',this.value)" class="w-full border rounded p-1 text-center font-bold outline-none"></div>
                            
                            <!-- Keterangan (Individual) -->
                            <div class="${isMulti ? 'col-span-5' : 'col-span-5'}"><input type="text" value="${sub.ket}" placeholder="Ket..." oninput="updSdtSub(${i},${subIdx},'ket',this.value)" class="w-full border rounded p-1 text-red-500 italic outline-none"></div>
                        </div>
                        `).join('')}
                    </div>
                </div>`;
            }).join('');
            lucide.createIcons();
            calcSdtTotal();
        }

        // --- COPY REPORT FIX ---
        function getChecked(id) {
            const c = Array.from(document.querySelectorAll(`#${id} input:checked`)).map(e => e.parentElement.innerText.trim());
            let mId = ''; if(id.includes('spv')) mId = 'inputSupervisorLainnya'; if(id.includes('foreman')) mId = 'inputForemanLainnya'; if(id.includes('checker')) mId = 'inputCheckerLainnya';
            const m = document.getElementById(mId).value.trim(); if(m) c.push(m); return c.join(', ');
        }

        function copyReport(isMalam) {
            saveData(true);
            const shift = document.getElementById('inputShift').value;
            const dateVal = document.getElementById('inputTanggal').value;
            const date = dateVal.split('-');
            const fmtDate = date.length===3 ? `${date[2]}/${["JAN","FEB","MAR","APR","MEI","JUN","JUL","AGU","SEP","OKT","NOV","DES"][parseInt(date[1])-1]}/${date[0].slice(-2)}` : '-';
            
            let haulingStr = "", unitStr = "";
            let totHauling = 0;

            appData.masters.pt.forEach(pt => {
                const k = toId(pt);
                if(document.getElementById(`${k}-run-siang`)) {
                    const rawVal = (id) => document.getElementById(id).value;
                    const val = (id) => parseFloat(document.getElementById(id).value)||0;
                    
                    const rsVal = val(`${k}-run-siang`), tsVal = val(`${k}-trip-siang`);
                    const rmVal = val(`${k}-run-malam`), tmVal = val(`${k}-trip-malam`);

                    const hasSiang = rawVal(`${k}-run-siang`) !== "" || rawVal(`${k}-trip-siang`) !== "";
                    const hasMalam = rawVal(`${k}-run-malam`) !== "" || rawVal(`${k}-trip-malam`) !== "";

                    let tripDisplay = 0, unit2TripDisplay = 0;
                    let isValidData = false;

                    if (isMalam) {
                        if (hasMalam) {
                            tripDisplay = (tmVal > 0) ? (tmVal - tsVal) : 0; 
                            unit2TripDisplay = tripDisplay - rmVal; 
                            isValidData = true;
                        }
                    } else {
                        if (hasSiang) {
                            tripDisplay = tsVal;
                            unit2TripDisplay = tsVal - rsVal; 
                            isValidData = true;
                        }
                    }

                    if (isValidData) {
                        haulingStr += `- ${pt} = ${tripDisplay} TRIP\n`;
                        unitStr += `- ${pt} = ${unit2TripDisplay} Unit\n`;
                    } else {
                        haulingStr += `- ${pt} = - TRIP\n`; 
                        unitStr += `- ${pt} = - Unit\n`;
                    }
                    totHauling += tripDisplay;
                }
            });

            const val = (id) => parseFloat(document.getElementById(id).value)||0;
            const tipVal = document.getElementById('inputTippingRom').value;
            const tip = tipVal === "" ? "-" : tipVal + " Trip";
            
            const totalSdtTrip = calcSdtTotal();
            const trans = totalSdtTrip === 0 ? "-" : totalSdtTrip + " Trip";

            let sdtStr = "";
            if (sdtData.length > 0) {
                sdtData.forEach(d => {
                    if (d.drivers.length > 1) {
                        // Nested format for multi-driver
                        sdtStr += `- ${d.unit} :\n`;
                        d.drivers.forEach(sub => {
                            const jamStr = sub.jam ? ` *${sub.jam}*` : '';
                            const ketStr = sub.ket ? ` *${sub.ket}*` : '';
                            sdtStr += `   - ${sub.name||'-'} : ${sub.trip||0} TRIP${jamStr}${ketStr}\n`;
                        });
                    } else {
                        // Single driver format
                        const sub = d.drivers[0];
                        const name = sub.name ? `(${sub.name})` : '';
                        const ketStr = sub.ket ? ` *${sub.ket}*` : '';
                        sdtStr += `- ${d.unit} ${name} : ${sub.trip||0} Trip${ketStr}\n`;
                    }
                });
            } else { sdtStr = "-\n"; }

            const spv = getChecked('spvContainer') || '-', frm = getChecked('foremanContainer') || '-', chk = getChecked('checkerContainer') || '-';
            const sd1 = document.getElementById('eff-SD1').dataset.copy, sd2 = document.getElementById('eff-SD2').dataset.copy, sd3 = document.getElementById('eff-SD3').dataset.copy;
            
            const totalTransHauling = totHauling + totalSdtTrip;

            const txt = `*CHP OPERATION*\n*${shift}*\n*${fmtDate}*\n\n*SUPERVISOR* : ${spv}\n*FOREMAN* : ${frm}\n*CHECKER* :  ${chk}\n\n*EFEKTIFITAS RUNNING*\n- SD1 = ${sd1}\n- SD2 = ${sd2}\n- SD3 = ${sd3}\n\n*HAULING*\n${haulingStr}\n*UNIT 2 TRIP*\n${unitStr}\n*TRIP SDT TRANSFER*\n${sdtStr}\n\n*TOTAL HAULING   = ${totHauling} Trip*\n*TIPPING ROM        = ${tip}*\n*TRANSFER ROM   = ${trans}*\n*TRANSFER ROM + HAULING = ${totalTransHauling} Trip*`;
            
            const ta = document.createElement('textarea'); ta.value = txt; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
            showToast("Teks Berhasil Disalin!");
        }
        function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.classList.remove('hidden','translate-y-10'); setTimeout(()=>t.classList.add('translate-y-10'), 2000); setTimeout(()=>t.classList.add('hidden'), 2300); }

        // --- ADMIN PAGE ---
        function renderAdmin() {
            const container = document.getElementById('admin-content'); container.innerHTML = '';
            const sections = [ {k:'spv', l:'Supervisor'}, {k:'foreman', l:'Foreman'}, {k:'checker', l:'Checker'}, {k:'pt', l:'Vendor / PT'}, {k:'unit', l:'Unit SDT'}, {k:'driver', l:'Driver SDT'} ];
            sections.forEach(sec => {
                let html = `<div class="border-b border-slate-100 pb-4 last:border-0"><div class="flex justify-between items-center mb-2"><h3 class="font-bold text-xs text-slate-500 uppercase">${sec.l}</h3><button onclick="reqAddMaster('${sec.k}')" class="text-[10px] font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded hover:bg-indigo-100">+ TAMBAH</button></div><div class="flex flex-wrap gap-2">`;
                appData.masters[sec.k].forEach(item => { html += `<div class="bg-slate-100 border border-slate-200 text-slate-600 text-[10px] font-bold px-2 py-1 rounded flex items-center gap-1">${item}<button onclick="reqDelMaster('${sec.k}','${item}')" class="text-slate-400 hover:text-red-500 ml-1">√ó</button></div>`; });
                html += `</div></div>`; container.innerHTML += html;
            });
        }
        function reqAddMaster(key) { showModal(`Tambah ${key}`, 'input', (val) => { appData.masters[key].push(val.toUpperCase()); saveToStorage(); renderAdmin(); initChips(); renderHaulingInputs(); renderUnitButtons(); }); }
        function reqDelMaster(key, val) { showModal(`Hapus ${val}?`, 'confirm', () => { appData.masters[key] = appData.masters[key].filter(x => x !== val); saveToStorage(); renderAdmin(); initChips(); renderHaulingInputs(); renderUnitButtons(); }, 'Yakin hapus data ini?'); }

    </script>
</body>
</html>


